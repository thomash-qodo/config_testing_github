<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simple To-Do List</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 60px 20px;
    }

    .app {
      width: 100%;
      max-width: 540px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
      padding: 32px 28px 24px;
      animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .app-title {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
    }

    .counter {
      font-size: 0.875rem;
      color: #6b7280;
      font-weight: 500;
      background: #f3f4f6;
      padding: 6px 12px;
      border-radius: 20px;
    }

    form {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    input[type="text"] {
      flex: 1;
      padding: 14px 18px;
      border-radius: 16px;
      border: 2px solid #e5e7eb;
      font-size: 0.95rem;
      outline: none;
      transition: all 0.2s ease;
      background: #fafafa;
    }

    input[type="text"]:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      background: #ffffff;
    }

    input[type="text"]::placeholder {
      color: #9ca3af;
    }

    button {
      border: none;
      border-radius: 14px;
      padding: 14px 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      letter-spacing: 0.3px;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-add {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      white-space: nowrap;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-add:hover {
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .btn-add:disabled {
      background: #d1d5db;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .filters {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .filter-buttons {
      display: flex;
      gap: 6px;
      background: #f3f4f6;
      padding: 4px;
      border-radius: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: transparent;
      border-radius: 10px;
      padding: 6px 14px;
      border: none;
      color: #6b7280;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      transform: none;
      box-shadow: none;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    .btn-clear {
      background: transparent;
      color: #ef4444;
      padding: 6px 12px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-clear:hover {
      background: rgba(239, 68, 68, 0.1);
      transform: none;
      box-shadow: none;
    }

    ul {
      list-style: none;
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #d1d5db #f3f4f6;
    }

    ul::-webkit-scrollbar {
      width: 8px;
    }

    ul::-webkit-scrollbar-track {
      background: #f3f4f6;
      border-radius: 10px;
    }

    ul::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 10px;
    }

    ul::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 12px;
      border-radius: 12px;
      margin-bottom: 8px;
      font-size: 0.95rem;
      background: #fafafa;
      border: 1px solid #f3f4f6;
      transition: all 0.2s ease;
    }

    li:hover {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    li:last-child {
      margin-bottom: 0;
    }

    .todo-main {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .todo-main input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #667eea;
    }

    .todo-text {
      flex: 1;
      word-break: break-word;
      color: #1f2937;
      line-height: 1.5;
    }

    .todo-text.completed {
      text-decoration: line-through;
      color: #9ca3af;
      opacity: 0.7;
    }

    .todo-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 0.75rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-small:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-delete {
      background: #fee2e2;
      color: #dc2626;
    }

    .btn-delete:hover {
      background: #fecaca;
    }

    .btn-edit {
      background: #e0e7ff;
      color: #4f46e5;
    }

    .btn-edit:hover {
      background: #c7d2fe;
    }

    .btn-derive {
      background: #dbeafe;
      color: #0284c7;
    }

    .btn-derive:hover {
      background: #bfdbfe;
    }

    .priority-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-left: 8px;
    }

    .priority-high {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .priority-medium {
      background: #fef3c7;
      color: #d97706;
      border: 1px solid #fde68a;
    }

    .priority-low {
      background: #dbeafe;
      color: #0284c7;
      border: 1px solid #bfdbfe;
    }

    .priority-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .priority-option {
      flex: 1;
      padding: 8px 12px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      background: #fafafa;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .priority-option:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .priority-option.selected-high {
      background: #fee2e2;
      color: #dc2626;
      border-color: #fecaca;
    }

    .priority-option.selected-medium {
      background: #fef3c7;
      color: #d97706;
      border-color: #fde68a;
    }

    .priority-option.selected-low {
      background: #dbeafe;
      color: #0284c7;
      border-color: #bfdbfe;
    }

    .sort-button {
      background: transparent;
      color: #6b7280;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid #e5e7eb;
      margin-left: 8px;
    }

    .sort-button:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border-color: #667eea;
      transform: none;
      box-shadow: none;
    }

    .sort-button.active {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      border-color: #667eea;
    }

    .date-input-wrapper {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
      align-items: center;
    }

    .date-input-wrapper label {
      font-size: 0.85rem;
      color: #6b7280;
      font-weight: 500;
      white-space: nowrap;
    }

    .date-input-wrapper input[type="date"] {
      flex: 1;
      padding: 8px 12px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      font-size: 0.85rem;
      outline: none;
      transition: all 0.2s ease;
      background: #fafafa;
      color: #1f2937;
    }

    .date-input-wrapper input[type="date"]:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: #ffffff;
    }

    .date-input-wrapper button {
      padding: 8px 12px;
      font-size: 0.75rem;
      border-radius: 8px;
    }

    .due-date-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .due-overdue {
      background: #fee2e2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .due-today {
      background: #fef3c7;
      color: #d97706;
      border: 1px solid #fde68a;
    }

    .due-upcoming {
      background: #dbeafe;
      color: #0284c7;
      border: 1px solid #bfdbfe;
    }

    .due-future {
      background: #f3f4f6;
      color: #6b7280;
      border: 1px solid #e5e7eb;
    }

    .category-selector {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .category-option {
      padding: 8px 14px;
      border-radius: 10px;
      border: 2px solid #e5e7eb;
      background: #fafafa;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }

    .category-option:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .category-option.selected {
      border-width: 2px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .category-work.selected {
      background: #dbeafe;
      color: #0284c7;
      border-color: #0284c7;
    }

    .category-personal.selected {
      background: #fce7f3;
      color: #db2777;
      border-color: #db2777;
    }

    .category-shopping.selected {
      background: #dcfce7;
      color: #16a34a;
      border-color: #16a34a;
    }

    .category-health.selected {
      background: #fef3c7;
      color: #d97706;
      border-color: #d97706;
    }

    .category-other.selected {
      background: #e0e7ff;
      color: #4f46e5;
      border-color: #4f46e5;
    }

    .category-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 8px;
    }

    .category-work {
      background: #dbeafe;
      color: #0284c7;
      border: 1px solid #bfdbfe;
    }

    .category-personal {
      background: #fce7f3;
      color: #db2777;
      border: 1px solid #fbcfe8;
    }

    .category-shopping {
      background: #dcfce7;
      color: #16a34a;
      border: 1px solid #bbf7d0;
    }

    .category-health {
      background: #fef3c7;
      color: #d97706;
      border: 1px solid #fde68a;
    }

    .category-other {
      background: #e0e7ff;
      color: #4f46e5;
      border: 1px solid #c7d2fe;
    }

    .category-filter-section {
      margin-bottom: 12px;
      padding: 12px;
      background: #fafafa;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }

    .category-filter-title {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .category-filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .category-filter-btn {
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .category-filter-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .category-filter-btn.active {
      border-width: 2px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .category-filter-btn.active.category-work {
      background: #dbeafe;
      color: #0284c7;
      border-color: #0284c7;
    }

    .category-filter-btn.active.category-personal {
      background: #fce7f3;
      color: #db2777;
      border-color: #db2777;
    }

    .category-filter-btn.active.category-shopping {
      background: #dcfce7;
      color: #16a34a;
      border-color: #16a34a;
    }

    .category-filter-btn.active.category-health {
      background: #fef3c7;
      color: #d97706;
      border-color: #d97706;
    }

    .category-filter-btn.active.category-other {
      background: #e0e7ff;
      color: #4f46e5;
      border-color: #4f46e5;
    }

    .empty-state {
      text-align: center;
      font-size: 0.9rem;
      color: #9ca3af;
      padding: 40px 20px;
      background: #fafafa;
      border-radius: 12px;
      border: 2px dashed #e5e7eb;
    }

    .secondary-panel {
      margin-top: 20px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      border-radius: 16px;
      border: 1px solid rgba(102, 126, 234, 0.1);
      font-size: 0.85rem;
      color: #4b5563;
    }

    .secondary-title {
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #1f2937;
    }

    .secondary-list {
      list-style: none;
      padding-left: 0;
      max-height: none;
    }

    .secondary-list li {
      padding: 10px 12px;
      margin-bottom: 6px;
      border: 1px solid rgba(102, 126, 234, 0.15);
      font-size: 0.85rem;
      color: #1f2937;
      background: rgba(255, 255, 255, 0.8);
    }

    .secondary-list li:hover {
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(102, 126, 234, 0.25);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.8);
      color: #4b5563;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid rgba(102, 126, 234, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 1);
      border-color: rgba(102, 126, 234, 0.3);
      transform: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 480px) {
      body {
        padding: 30px 16px;
      }

      .app {
        padding: 24px 20px 20px;
        border-radius: 20px;
      }

      .app-title {
        font-size: 1.75rem;
      }

      input[type="text"] {
        padding: 12px 16px;
      }

      button {
        padding: 12px 16px;
      }

      li {
        padding: 12px 10px;
      }

      .todo-actions {
        flex-direction: column;
        gap: 4px;
      }

      .btn-small {
        width: 100%;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">To-Do</div>
      <div class="counter" id="counter">0 tasks</div>
    </header>

    <form id="todo-form">
      <input
        id="todo-input"
        type="text"
        placeholder="Add a new task and press Enter..."
        autocomplete="off"
      />
      <button type="submit" class="btn-add" id="add-btn" disabled>Add</button>
    </form>

    <div class="priority-selector">
      <button type="button" class="priority-option selected-medium" data-priority="medium">Medium</button>
      <button type="button" class="priority-option" data-priority="high">High</button>
      <button type="button" class="priority-option" data-priority="low">Low</button>
    </div>

    <div class="date-input-wrapper">
      <label for="due-date-input">Due Date:</label>
      <input type="date" id="due-date-input" />
      <button type="button" class="btn-secondary" id="clear-date-btn">Clear</button>
    </div>

    <div class="category-selector">
      <button type="button" class="category-option category-work" data-category="work">üíº Work</button>
      <button type="button" class="category-option category-personal" data-category="personal">üè† Personal</button>
      <button type="button" class="category-option category-shopping" data-category="shopping">üõí Shopping</button>
      <button type="button" class="category-option category-health" data-category="health">üí™ Health</button>
      <button type="button" class="category-option category-other selected" data-category="other">üìå Other</button>
    </div>

    <div class="category-filter-section">
      <div class="category-filter-title">Filter by Category:</div>
      <div class="category-filters">
        <button type="button" class="category-filter-btn" data-category-filter="all">All</button>
        <button type="button" class="category-filter-btn category-work" data-category-filter="work">üíº Work</button>
        <button type="button" class="category-filter-btn category-personal" data-category-filter="personal">üè† Personal</button>
        <button type="button" class="category-filter-btn category-shopping" data-category-filter="shopping">üõí Shopping</button>
        <button type="button" class="category-filter-btn category-health" data-category-filter="health">üí™ Health</button>
        <button type="button" class="category-filter-btn category-other" data-category-filter="other">üìå Other</button>
      </div>
    </div>

    <div class="filters">
      <div class="filter-buttons">
        <button type="button" class="filter-btn active" data-filter="all">All</button>
        <button type="button" class="filter-btn" data-filter="active">Active</button>
        <button type="button" class="filter-btn" data-filter="completed">Completed</button>
        <button type="button" class="sort-button" id="sort-priority">Sort by Priority</button>
      </div>
      <button type="button" class="btn-clear" id="clear-completed">Clear completed</button>
    </div>

    <ul id="todo-list"></ul>
    <div class="empty-state" id="empty-state">No tasks yet. Add your first one above.</div>

    <div class="secondary-panel" id="derived-list-panel" style="display: none;">
      <div class="secondary-title">
        <span>Derived list from selected item</span>
        <button type="button" class="btn-secondary" id="clear-derived">Clear</button>
      </div>
      <ul class="secondary-list" id="derived-list"></ul>
    </div>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = 'simple_todo_items_v1';
      const DERIVED_STORAGE_KEY = 'simple_todo_derived_v1';

      /** @type {{ id: string; text: string; completed: boolean; priority: 'high' | 'medium' | 'low'; dueDate: string | null; category: string; }[]} */
      let todos = [];
      let currentFilter = 'all';
      let currentPriority = 'medium';
      let sortByPriority = false;
      let currentDueDate = null;
      let currentCategory = 'other';
      let categoryFilter = 'all';
      /** @type {{ sourceId: string | null; items: { id: string; text: string; completed: boolean; }[] }} */
      let derivedState = { sourceId: null, items: [] };

      const form = document.getElementById('todo-form');
      const input = document.getElementById('todo-input');
      const addBtn = document.getElementById('add-btn');
      const list = document.getElementById('todo-list');
      const counter = document.getElementById('counter');
      const emptyState = document.getElementById('empty-state');
      const filterButtons = document.querySelectorAll('.filter-btn');
      const clearCompletedBtn = document.getElementById('clear-completed');
      const derivedPanel = document.getElementById('derived-list-panel');
      const derivedListEl = document.getElementById('derived-list');
      const clearDerivedBtn = document.getElementById('clear-derived');
      const priorityOptions = document.querySelectorAll('.priority-option');
      const sortPriorityBtn = document.getElementById('sort-priority');
      const dueDateInput = document.getElementById('due-date-input');
      const clearDateBtn = document.getElementById('clear-date-btn');
      const categoryOptions = document.querySelectorAll('.category-option');
      const categoryFilterBtns = document.querySelectorAll('.category-filter-btn');

      function loadFromStorage() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            todos = parsed;
          }
        } catch (e) {
          console.error('Failed to load todos from storage', e);
        }

        try {
          const rawDerived = localStorage.getItem(DERIVED_STORAGE_KEY);
          if (!rawDerived) return;
          
          const parsedDerived = JSON.parse(rawDerived);
          if (parsedDerived && typeof parsedDerived === 'object') {
            derivedState = {
              sourceId: parsedDerived.sourceId || null,
              items: Array.isArray(parsedDerived.items) ? parsedDerived.items : [],
            };
          }
        } catch (e) {
          console.error('Failed to load derived list from storage', e);
        }
      }

      function saveToStorage() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
        } catch (e) {
          console.error('Failed to save todos to storage', e);
        }

        try {
          localStorage.setItem(DERIVED_STORAGE_KEY, JSON.stringify(derivedState));
        } catch (e) {
          console.error('Failed to save derived list to storage', e);
        }
      }

      function updateCounter() {
        const total = todos.length;
        const remaining = todos.filter(t => !t.completed).length;
        const label = total === 1 ? 'task' : 'tasks';
        counter.textContent = `${remaining} of ${total} ${label} left`;
      }

      function getPriorityValue(priority) {
        const values = { high: 3, medium: 2, low: 1 };
        return values[priority] || 2;
      }

      function getPriorityLabel(priority) {
        const labels = { high: 'High', medium: 'Medium', low: 'Low' };
        return labels[priority] || 'Medium';
      }

      function getDueDateStatus(dueDate) {
        if (!dueDate) return null;
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const due = new Date(dueDate);
        due.setHours(0, 0, 0, 0);
        
        const diffTime = due - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) return 'overdue';
        if (diffDays === 0) return 'today';
        if (diffDays <= 3) return 'upcoming';
        return 'future';
      }

      function formatDueDate(dueDate) {
        if (!dueDate) return '';
        
        const date = new Date(dueDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const due = new Date(dueDate);
        due.setHours(0, 0, 0, 0);
        
        const diffTime = due - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
          const absDays = Math.abs(diffDays);
          return `${absDays} day${absDays === 1 ? '' : 's'} overdue`;
        }
        if (diffDays === 0) return 'Due today';
        if (diffDays === 1) return 'Due tomorrow';
        if (diffDays <= 7) return `Due in ${diffDays} days`;
        
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function getCategoryLabel(category) {
        const labels = {
          work: 'üíº Work',
          personal: 'üè† Personal',
          shopping: 'üõí Shopping',
          health: 'üí™ Health',
          other: 'üìå Other'
        };
        return labels[category] || 'üìå Other';
      }

      function renderDerivedList() {
        if (!derivedState.sourceId || derivedState.items.length === 0) {
          derivedPanel.style.display = 'none';
          derivedListEl.innerHTML = '';
          return;
        }

        derivedPanel.style.display = 'block';
        derivedListEl.innerHTML = '';
        derivedState.items.forEach(item => {
          const li = document.createElement('li');
          li.textContent = item.text;
          derivedListEl.appendChild(li);
        });
      }

      function render() {
        list.innerHTML = '';

        let visible = todos;
        if (currentFilter === 'active') {
          visible = todos.filter(t => !t.completed);
        } else if (currentFilter === 'completed') {
          visible = todos.filter(t => t.completed);
        }

        if (categoryFilter !== 'all') {
          visible = visible.filter(t => t.category === categoryFilter);
        }

        if (sortByPriority) {
          visible = [...visible].sort((a, b) => {
            return getPriorityValue(b.priority) - getPriorityValue(a.priority);
          });
        }

        if (visible.length === 0) {
          emptyState.style.display = 'block';
        } else {
          emptyState.style.display = 'none';
        }

        visible.forEach(todo => {
          const li = document.createElement('li');

          const main = document.createElement('div');
          main.className = 'todo-main';

          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = todo.completed;
          checkbox.addEventListener('change', () => {
            toggleTodo(todo.id);
          });

          const span = document.createElement('span');
          span.className = 'todo-text' + (todo.completed ? ' completed' : '');
          span.textContent = todo.text;

          const categoryBadge = document.createElement('span');
          categoryBadge.className = `category-badge category-${todo.category}`;
          categoryBadge.textContent = getCategoryLabel(todo.category);

          const priorityBadge = document.createElement('span');
          priorityBadge.className = `priority-badge priority-${todo.priority}`;
          priorityBadge.textContent = getPriorityLabel(todo.priority);

          main.appendChild(checkbox);
          main.appendChild(span);
          main.appendChild(categoryBadge);
          main.appendChild(priorityBadge);

          if (todo.dueDate) {
            const dueDateBadge = document.createElement('span');
            const status = getDueDateStatus(todo.dueDate);
            dueDateBadge.className = `due-date-badge due-${status}`;
            dueDateBadge.textContent = formatDueDate(todo.dueDate);
            main.appendChild(dueDateBadge);
          }

          const actions = document.createElement('div');
          actions.className = 'todo-actions';

          const editBtn = document.createElement('button');
          editBtn.type = 'button';
          editBtn.textContent = 'Edit';
          editBtn.className = 'btn-small btn-edit';
          editBtn.addEventListener('click', () => startEditTodo(todo.id));

          const deriveBtn = document.createElement('button');
          deriveBtn.type = 'button';
          deriveBtn.textContent = 'Use as new list';
          deriveBtn.className = 'btn-small btn-derive';
          deriveBtn.addEventListener('click', () => createDerivedListFrom(todo.id));

          const deleteBtn = document.createElement('button');
          deleteBtn.type = 'button';
          deleteBtn.textContent = 'Delete';
          deleteBtn.className = 'btn-small btn-delete';
          deleteBtn.addEventListener('click', () => deleteTodo(todo.id));

          actions.appendChild(editBtn);
          actions.appendChild(deriveBtn);
          actions.appendChild(deleteBtn);

          li.appendChild(main);
          li.appendChild(actions);

          list.appendChild(li);
        });

        updateCounter();
        renderDerivedList();
      }

      function addTodo(text) {
        const trimmed = text.trim();
        if (!trimmed) return;
        todos.unshift({
          id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
          text: trimmed,
          completed: false,
          priority: currentPriority,
          dueDate: currentDueDate,
          category: currentCategory,
        });
        saveToStorage();
        render();
      }

      function toggleTodo(id) {
        todos = todos.map(t => (t.id === id ? { ...t, completed: !t.completed } : t));
        saveToStorage();
        render();
      }

      function deleteTodo(id) {
        todos = todos.filter(t => t.id !== id);

        if (derivedState.sourceId === id) {
          derivedState = { sourceId: null, items: [] };
        }

        saveToStorage();
        render();
      }

      function startEditTodo(id) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;
        const nextText = prompt('Edit task:', todo.text);
        if (nextText === null) return;
        const trimmed = nextText.trim();
        if (!trimmed) {
          deleteTodo(id);
          return;
        }
        todos = todos.map(t => (t.id === id ? { ...t, text: trimmed } : t));

        if (derivedState.sourceId === id && derivedState.items.length > 0) {
          derivedState.items[0] = { ...derivedState.items[0], text: trimmed };
        }

        saveToStorage();
        render();
      }

      function clearCompleted() {
        todos = todos.filter(t => !t.completed);
        saveToStorage();
        render();
      }

      function setFilter(filter) {
        currentFilter = filter;
        filterButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.filter === filter);
        });
        render();
      }

      function setPriority(priority) {
        currentPriority = priority;
        priorityOptions.forEach(btn => {
          btn.classList.remove('selected-high', 'selected-medium', 'selected-low');
          if (btn.dataset.priority === priority) {
            btn.classList.add(`selected-${priority}`);
          }
        });
      }

      function toggleSortByPriority() {
        sortByPriority = !sortByPriority;
        sortPriorityBtn.classList.toggle('active', sortByPriority);
        render();
      }

      function setCategory(category) {
        currentCategory = category;
        categoryOptions.forEach(btn => {
          btn.classList.toggle('selected', btn.dataset.category === category);
        });
      }

      function setCategoryFilter(category) {
        categoryFilter = category;
        categoryFilterBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.categoryFilter === category);
        });
        render();
      }

      function createDerivedListFrom(id) {
        const todo = todos.find(t => t.id === id);
        if (!todo) return;

        derivedState = {
          sourceId: id,
          items: [
            {
              id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6),
              text: todo.text,
              completed: false,
            },
          ],
        };

        saveToStorage();
        renderDerivedList();
      }

      function clearDerived() {
        derivedState = { sourceId: null, items: [] };
        saveToStorage();
        renderDerivedList();
      }

      form.addEventListener('submit', e => {
        e.preventDefault();
        addTodo(input.value);
        input.value = '';
        addBtn.disabled = true;
      });

      input.addEventListener('input', () => {
        addBtn.disabled = !input.value.trim();
      });

      filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;
          if (filter) {
            setFilter(filter);
          }
        });
      });

      clearCompletedBtn.addEventListener('click', clearCompleted);
      clearDerivedBtn.addEventListener('click', clearDerived);

      priorityOptions.forEach(btn => {
        btn.addEventListener('click', () => {
          const priority = btn.dataset.priority;
          if (priority) {
            setPriority(priority);
          }
        });
      });

      sortPriorityBtn.addEventListener('click', toggleSortByPriority);

      dueDateInput.addEventListener('change', (e) => {
        currentDueDate = e.target.value || null;
      });

      clearDateBtn.addEventListener('click', () => {
        dueDateInput.value = '';
        currentDueDate = null;
      });

      categoryOptions.forEach(btn => {
        btn.addEventListener('click', () => {
          const category = btn.dataset.category;
          if (category) {
            setCategory(category);
          }
        });
      });

      categoryFilterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const category = btn.dataset.categoryFilter;
          if (category) {
            setCategoryFilter(category);
          }
        });
      });

      loadFromStorage();
      render();
    })();
  </script>
</body>
</html>
